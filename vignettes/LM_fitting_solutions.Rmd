---
title: "LM: fitting procedures"
subtitle: "Solutions"
author: "Alexandre Courtiol"
date: "`r Sys.Date()`"
output:
  html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{2.1 z-------------------------------------------------------------solutions}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(LM2GLMM)
knitr::opts_chunk$set(cache = FALSE,
                      fig.align = "center",
                      fig.width = 7,
                      fig.height = 5,
                      cache.path = "./cache_knitr/Exo_LM_fitting_solution/",
                      fig.path = "./fig_knitr/Exo_LM_fitting_solution/")
options(width = 90)
set.seed(1L)
```

## Fitting a LM by REML

### Instruction

In LM, REstricted Maximum Likelihood (aka REML) fits correspond to fits for which the (log-)likelihood is computed based on a data generating process that is gaussian (as in ML) and that use as variance for the distribution the error variance estimate rather than the population residual variance.

Adapt the code shown in the course to compute the log restricted likelihood of the REML fit with formula `size ~ humans_eaten` using the following data:

```{r}
set.seed(123)
Alien <- simulate_Aliens()
```

Compare the results with the outcome of the following call:

```{r, message=FALSE}
library(spaMM)
fit_spaMM_REML    <- fitme(size ~ humans_eaten, data = Alien, method = "REML")
```

### Solution

We adapt the function from the course by proposing 2 ways to compute the variance (ML or REML):

```{r}
compute_logLik2 <- function(vector.param, formula, data, REML = FALSE) { ## ML is the default
  useful.data <- model.frame(formula = formula, data = data)
  X <- model.matrix(object = formula, data = useful.data)
  fitted_values <- X %*% matrix(vector.param)
  response <- model.response(useful.data)
  error_variance_top <- sum((response - fitted_values)^2) 
  error_variance_bottom <- ifelse(REML, nrow(useful.data) - ncol(X), nrow(useful.data))
  error_variance <- error_variance_top / error_variance_bottom
  sum(dnorm(response, mean = fitted_values, sd = sqrt(error_variance), log = TRUE))
}
```

We run the new function on the data:

```{r}
res_optim_REML <- optim(par = c("intercept" = 0, "slope" = 1),
                      fn = compute_logLik2,
                      formula = size ~ humans_eaten,
                      REML = TRUE,
                      data = Alien,
                      control = list(fnscale = -1))
```

We extract the log-likelihood:

```{r}
res_optim_REML$value
```

Let's compare to the output from **{spaMM}**:

```{r}
fit_spaMM_REML
```

Our value correspond to what is called `p(h)   (Likelihood)` `r .emo("party")`
