---
title: "LM: fitting procedures"
subtitle: "Solutions"
author: "Alexandre Courtiol"
date: "`r Sys.Date()`"
output:
  html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{2.1 z-------------------------------------------------------------solutions}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(LM2GLMM)
knitr::opts_chunk$set(cache = FALSE,
                      fig.align = "center",
                      fig.width = 7,
                      fig.height = 5,
                      cache.path = "./cache_knitr/Exo_LM_fitting_solution/",
                      fig.path = "./fig_knitr/Exo_LM_fitting_solution/")
options(width = 90)
set.seed(1L)
```

## Fitting a LM with REML estimation of the error variance

### Instruction

Adapt the code shown in the course to compute the log-likelihood of the fit as the function of the error variance estimate rather than the population residual variance.

As in the course, use `size ~ humans_eaten` as the formula and the following data:

```{r}
set.seed(123)
Alien <- simulate_Aliens()
```

Compare the results with the outcome of the following call:

```{r, message=FALSE}
library(spaMM)
fit_spaMM_REML <- fitme(size ~ humans_eaten, data = Alien, method = "REML")
```

### Solution

We adapt the function from the course by proposing 2 ways to compute the variance (ML or REML estimation):

```{r}
compute_logLik2 <- function(vector.param, formula, data, varREML = FALSE) {
  useful.data <- model.frame(formula = formula, data = data)
  X <- model.matrix(object = formula, data = useful.data)
  fitted_values <- X %*% matrix(vector.param)
  response <- model.response(useful.data)
  error_variance_top <- sum((response - fitted_values)^2) 
  error_variance_bottom <- ifelse(varREML, nrow(useful.data) - ncol(X), nrow(useful.data))
  error_variance <- error_variance_top / error_variance_bottom
  sum(dnorm(response, mean = fitted_values, sd = sqrt(error_variance), log = TRUE))
}
```

We run the new function on the data:

```{r}
res_optim_REML <- optim(par = c("intercept" = 0, "slope" = 1),
                      fn = compute_logLik2,
                      formula = size ~ humans_eaten,
                      varREML = TRUE,
                      data = Alien,
                      control = list(fnscale = -1))
```

We extract the log-likelihood:

```{r}
res_optim_REML$value
```

Let's compare to the output from **{spaMM}**:

```{r}
fit_spaMM_REML
```

Our value correspond to what is called `p(h)   (Likelihood)` `r .emo("party")`
