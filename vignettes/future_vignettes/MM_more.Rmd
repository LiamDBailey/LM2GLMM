---
title: "Extensions from (G)LMM"
author: "Alexandre Courtiol"
date: "`r Sys.Date()`"
output:
  ioslides_presentation:
    smaller: yes
    widescreen: yes
vignette: >
  %\VignetteIndexEntry{4.5 More complex mixed models}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(LM2GLMM)
library(spaMM)
library(lme4)
spaMM.options(nb_cores = 4L)
options(width = 120)
knitr::opts_chunk$set(cache = TRUE, cache.path = "./cache_knitr/MM_more/", fig.path = "./fig_knitr/MM_more/", fig.width = 5, fig.height = 5, fig.align = "center", error = FALSE)
```

## Mixed-effects models

* 4.0 [Introduction to LMM](./LMM_intro.html)
* 4.1 [Random effects](./LMM_random.html)
* 4.2 [Solving LM problems using LMM](./LMM_solving_pb.html)
* 4.3 [A showcase of some useful applications](./LMM_showcase.html)
* 4.4 [Introduction to GLMM](./GLMM_intro.html)
* 4.5 [More complex mixed models](./MM_more.html)

## You will learn in this session

* that random effects as well can have non Gaussian distribution
* that there are even more general methods than GLMM out there: HGLM and DHGLM


# Non gaussian random effects

## The Hierarchical GLM (HGLM)

$$\begin{array}{lcl}
\mu &=& g^{-1}(\eta)\\
\mu &=& g^{-1}(\mathbf{X}\beta + \mathbf{Z}b)\\
\mu &=& g^{-1}(\mathbf{X}\beta + \mathbf{Z}f(u))
\end{array}
$$

<br>

Note: 

* If $f(u)$ is the identity function and $u$ is drawn for a normal distribution, then we have the GLMM, a particular case of the more general HGLM.
* Hence LM, GLM, LMM and GLMM are all particular cases of the HGLM.


## Negative binomial as a gamma poisson mixture

```{r glm.nb}
library(MASS)

mod_negbin <- glm.nb(Days ~ Sex/Age, data = quine)

quine$index <- factor(1:nrow(quine))

mod_poiss_gamma <- fitme(Days ~ Sex/Age + (1|index), data = quine,
                         family = poisson(), rand.family = Gamma("log"))

rbind(mod_negbin$coefficients, mod_poiss_gamma$fixef)
```

<br>

Note 1: the equivalence is expected! In more complex models differences may appear.

Note 2: notice the formula which prevents the estimation of intercepts for ```Age```.


# An example of many difficulties combined: ```IsoriX```


## What is ```IsoriX```?

```{r library IsoriX}
library(IsoriX)
```


## Loading the ```GNIPDataDE``` data

```{r GNIPData}
dim(GNIPDataDE)
head(GNIPDataDE)
```


## Aggregate the ```GNIPDataDE```
```{r GNIPData_agg}
GNIPDataDE_agg <- prepdata(data = GNIPDataDE)
dim(GNIPDataDE_agg)
head(GNIPDataDE_agg)
```


## ```IsoriX``` using ```IsoriX```

```{r isofit, warning=FALSE}
(Europefit <- isofit(iso.data = GNIPDataDE_agg, mean.model.fix = list(elev = TRUE, lat.abs = TRUE)))
```


## The data for the elevation

```{r plot elev, message = FALSE}
library(rasterVis)
plot(ElevRasterDE)
```


## ```IsoriX``` using ```IsoriX```
```{r isorix, warning = FALSE}
isoscape <- isoscape(elevation.raster = ElevRasterDE, isofit = Europefit)

plot.mean <- plot(x = isoscape, which = "mean", plot = FALSE)

plot.disp <- plot(x = isoscape, which = "disp", plot = FALSE)
```


## Mean prediction of the distribution of Deuterium

```{r plot mean}
plot.mean
```

## Prediction of the residual variance in Deuterium

```{r plot disp}
plot.disp
```


## ```IsoriX``` using ```spaMM```

```{r fit disp}
disp.fit <- fitme(var.isoscape.value ~ 1 + Matern(1 | long + lat), family = Gamma(log),
                  prior.weights = n.isoscape.value - 1, method = "REML", fixed = list(phi = 2),
                  control.dist = list(dist.method = "Earth"), data = GNIPDataDE_agg)
```

```{r disp transfer}
GNIPDataDE_agg$pred.disp <- predict(disp.fit)[, 1]
```

```{r fit mean}
mean.fit <- fitme(isoscape.value ~ lat + elev + Matern(1 | long + lat), family = gaussian(), 
                  prior.weights = n.isoscape.value, method = "REML",
                  resid.model = list(formula = ~ 0 + offset(pred.disp), family = Gamma(identity)),
                  control.dist = list(dist.method = "Earth"), data = GNIPDataDE_agg)
```

```{r list}
Europefit2 <- list(mean.fit = mean.fit, disp.fit = disp.fit)
```


## Predictions

```{r plot pred isorix, warning=FALSE, message=FALSE}
isoscape2 <- isoscape(elevation.raster = ElevRasterDE, isofit = Europefit2)
plot(x = isoscape2, which = "mean", plot = TRUE)
```


## DHGLM

```{r DHGLM, warning = FALSE, message = FALSE, eval = FALSE}
system.time(
  dhglm <- corrHLfit(isoscape.value ~ lat + elev + Matern(1 | long + lat), family = gaussian(), 
              HLmethod = "REML", data = GNIPDataDE, control.dist = list(dist.method = "Earth"),
              resid.model = list(formula = ~ 1 + Matern(1 | long + lat),
                                 control.dist = list(dist.method = "Earth"),
                                 family = Gamma(log), fixed = list(phi = 2)),
                                 verbose = c(TRACE = TRUE))
)
```


## What you need to remember

* that random effects as well can have non Gaussian distribution
* that there are even more general methods than GLMM out there: HGLM and DHGLM


# Table of contents

## Mixed-effects models

* 4.0 [Introduction to LMM](./LMM_intro.html)
* 4.1 [Random effects](./LMM_random.html)
* 4.2 [Solving LM problems using LMM](./LMM_solving_pb.html)
* 4.3 [A showcase of some useful applications](./LMM_showcase.html)
* 4.4 [Introduction to GLMM](./GLMM_intro.html)
* 4.5 [More complex mixed models](./MM_more.html)

